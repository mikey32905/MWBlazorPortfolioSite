@inherits LayoutComponentBase
@inject ThemeService ThemeSvc
@inject ProjectStateService ProjectState
@inject ProjectManifestService Manifest
@inject HttpClient Http
@implements IDisposable

<BootScreen />

@* This dynamic style block listens to the ThemeService *@
<style>
    :root {
        --accent-glow: @ThemeSvc.CurrentColor;
        --accent-rgb: @ThemeSvc.GetRgbValues();
        @* For transparent glows *@
    }
</style>

<div class="app-shell" style="--accent-glow: @ThemeSvc.CurrentColor;">
   
 
    <header class="system-header">
        <div class="logo">PORTFOLIO_OS // @(ThemeSvc.CurrentColor == "#39FF14" ? "WPF_MODE" : "WASM_MODE")</div>
        <nav class="system-controls">
            <span>RUN</span>
            <span>DEBUG</span>
            <div class="battery-status">100% [AC_POWER]</div>
        </nav>
    </header>

    <aside class="sidebar">
        <SideBar OnFileSelected="UpdateSelection"/>
    </aside>
    @* The Sidebar with dynamic classes *@
   @*  <div class="sidebar @(isMenuOpen ? "mobile-open" : "mobile-collapsed")">
        <SideBar OnFileSelected="UpdateSelection"/>
    </div> *@

    <main class="content-area">
        <ProjectStage />
        @* @if (SelectedFile == null)
        {
            <EmptyState />
        }
        else
        {
            @Body
        } *@
    </main>

    <footer class="terminal-area">
        <TerminalComponent />
    </footer>

</div>

<div class="crt-overlay"></div>

@code {
    // 1. Declare the missing variable
    // bool isMenuOpen = false;
    // private void ToggleMobileMenu() => isMenuOpen = !isMenuOpen;

    public ProjectFile? SelectedFile { get; set; } // The variable you saw in Line 20

    protected override async Task OnInitializedAsync()
    {
        // Only load if the list is currently empty
        if (ProjectState.ProjectFiles == null || !ProjectState.ProjectFiles.Any())
        {
            var rawData = await Http.GetFromJsonAsync<List<ProjectFile>>("Data/projects.json");
            if (rawData != null)
            {
                ProjectState.LoadProjects(rawData);
                StateHasChanged(); // Tell the sidebar to wake up and show the files
            }
        }
       // await Manifest.InitializeAsync();
        // Subscribe to selection changes
        ProjectState.OnSelectedFileChanged += HandleFileSelection;
    }

    private void HandleFileSelection()
    {
      //  isMenuOpen = false; // Automatically close the drawer
        StateHasChanged();  // Refresh the UI
    }

    private void UpdateSelection(ProjectFile file)
    {
        SelectedFile = file; // The variable is "Set" here!
    }

    public void Dispose()
    {
        ProjectState.OnSelectedFileChanged -= HandleFileSelection;
    }
}
