@page "/wpf-viewer"

@layout PortfolioLayout
@inject ThemeService ThemeSvc
@inject TerminalService TerminalSvc
@inject ProjectStateService ProjectState
@inject HttpClient Http
@inject IJSRuntime JS
@implements IDisposable

<div class="wpf-container">
    <div class="wpf-layout">
        <div class="blueprint-pane">
            <div class="briefing-header">
                <span class="pulse-dot"></span>
                <h4 class="briefing-title">> PROJECT_LOG_SUMMARY</h4>
                @* <h3 class="pane-title">> UI_SCHEMATIC_PREVIEW</h3> *@
            </div>

            <div class="briefing-body">
                @if (ProjectState.SelectedFile?.Description != null && ProjectState.SelectedFile.Description.Any())
                {
                    <div class="glitch-container" @key="ProjectState.SelectedFile.FileName">
                        @foreach (var logEntry in ProjectState.SelectedFile.Description)
                        {
                            <div class="log-row @(isGlitched ? "glitch-text" : "")">
                                <span class="line-prefix">[LOG]:</span>
                                <p class="briefing-text">@logEntry</p>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="briefing-text opacity-50">NO_DESCRIPTION_DATA_RECOVERED...</p>
                }
            </div>
            
            <div class="blueprint-frame">

                @if (!string.IsNullOrEmpty(ProjectState.SelectedFile?.BlueprintUrl))
                {
                    <div class="image-container @(isGlitched ? "glitch-image" : "")">
                        <img src="@ProjectState.SelectedFile.BlueprintUrl" class="blueprint-img" 
                             style="width: 100%; height: auto; display: block;"
                             alt="System Blueprint" />
                    </div>
                }
                else
                {
                    <div class="no-asset-warning">MISSING_VISUAL_ASSET</div>
                }
                
                <div class="scan-overlay"></div>

                <div class="overlay-grid"></div>
            </div>

            <div class="blueprint-metadata">
                @if (ProjectState.SelectedFile?.Metadata != null)
                {
                    @foreach (var entry in ProjectState.SelectedFile.Metadata)
                    {
                        <div class="meta-box">
                            <label>@entry.Key.Replace("_", " ")</label>
                            <span class="glow-text">@entry.Value</span>
                        </div>
                    }
                }
                else
                {
                    <div class="meta-box">
                        <label>STATUS</label>
                        <span>NO_METADATA_AVAILABLE</span>
                    </div>
                }
            </div>

            @if (!string.IsNullOrEmpty(ProjectState.SelectedFile?.GitHubUrl))
            {
                <a href="@ProjectState.SelectedFile.GitHubUrl" target="_blank" class="github-repo-btn">
                    <svg viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" />
                    </svg>
                    <span class="btn-text">ACCESS_FULL_REPOSITORY</span>
                    <span class="btn-subtext">VIEW_SOURCE_ON_GITHUB</span>
                </a>
            }
        </div>

        <div class="xaml-pane">
            <div class="pane-header">
                
                <h3 class="pane-title">> SOURCE_FILES</h3>

                <div class="header-actions">
                    @if (ProjectState.SelectedFile?.SupportingFiles?.Any() == true)
                    {
                        @if (!string.IsNullOrEmpty(ProjectState.SelectedFile?.DownloadUrl))
                        {
                            <a href="@ProjectState.SelectedFile.DownloadUrl"
                               @onclick="LogDownload"
                               target="_blank"
                               class="download-link">
                                <span class="version-tag">@ProjectState.SelectedFile.Version</span>
                                <span class="btn-text">[ GET_EXECUTABLE.EXE ]</span>
                            </a>
                        }

                        <div class="wpf-header-actions">
                            @* Manual Specs Tab *@
                            <button class="tab-btn @(activeTab == "SPECS" ? "active" : "")"
                                    @onclick='() => LoadTab("SPECS", "INTERNAL")'>
                                [SPECS]
                            </button>

                            <div class="mini-tabs">
                                @foreach (var file in ProjectState.SelectedFile.SupportingFiles)
                                {
                                    @* Ensure you are capturing the current 'file' variables correctly *@
                                    var tabLabel = file.Key;
                                    var tabUrl = file.Value;

                                    <button class="tab-btn @(activeTab == tabLabel ? "active" : "")"
                                            @onclick="() => LoadTab(tabLabel, tabUrl)">
                                        @tabLabel
                                    </button>
                                }
                            </div>
                        </div>
                     
                    }
                </div>
            </div>

            
            <div class="editor-wrapper">
                <div class="scrolling-content">
                    @if (activeTab == "SPECS" || isDecrypting)
                    {
                        <div class="manifest-dossier @(isDecrypting ? "shimmer-text" : "")">
                            <h2 class="manifest-title">> MODULE_SPECS: @ProjectState.SelectedFile?.ModuleName</h2>
                            <div class="manifest-body">
                                <p><span class="label">STATUS:</span> @ProjectState.SelectedFile?.Status</p>
                                
                                <div class="description-block">
                                    <span class="label">DESCRIPTION:</span>
                                    <div class="log-entries">
                                        @if (ProjectState.SelectedFile?.Description != null)
                                        {
                                            @foreach (var line in ProjectState.SelectedFile.Description)
                                            {
                                                <p class="log-line"><span class="log-tag">[LOG]:</span> @line</p>
                                            }
                                        }
                                    </div>
                                </div>

                                @* <p><span class="label">DESCRIPTION:</span> @ProjectState.SelectedFile?.Description</p> *@

                                <div class="tech-stack">
                                    <span class="label">CORE_TECH:</span>
                                    @foreach (var tech in ProjectState.SelectedFile?.CoreTech)
                                    {
                                        <span class="tech-tag">@tech</span>
                                    }
                                </div>

                                <div class="sys-metrics">
                                    <p>CPU_CYCLES: OPTIMIZED</p>
                                    <p>DATA_FLOW: STABLE</p>
                                    <p>RENDER_CORE: WPF_XAML</p>
                                </div>
                            </div>
                        </div>
                    }
                    else if (!string.IsNullOrEmpty(currentCodeBody))
                    {
                        @* Wrapping in a unique Key forces Blazor to treat this as a NEW element *@
                        <div @key="activeTab">
                            <pre class="line-numbers"><code class="@GetLanguageClass(activeTab)">@currentCodeBody</code></pre>
                        </div>
                    }
                    else
                    {
                        <div class="loading-overlay">
                            <span class="pulse">FETCHING_REMOTE_DATA...</span>
                        </div>
                    }
                </div>
             </div>
        </div>
    </div>
</div>

@code {
    private string? xamlContent;

    [Parameter] public ProjectFile Project { get; set; } = new();
    [Inject] NavigationManager Nav { get; set; }

    private string activeTab = "SPECS";
    private bool isGlitched = true;
    private bool showSpecs = false;
    private string currentCodeBody = "";
    private bool isDecrypting = false;

    protected override void OnInitialized()
    {
        // Listen for when the HttpClient finishes loading the text
        ProjectState.OnChange += HandleProjectSwitch;
    }

    protected override async Task OnInitializedAsync()
    {
        ProjectState.OnChange += async () => await LoadProjectData();
        await LoadProjectData();
    }

    protected override async Task OnParametersSetAsync()
    {
        // 1. Start the visual reset
        activeTab = "SPECS";
        currentCodeBody = "";
        isDecrypting = true; // Start the shimmer

        // 2. Log the change to terminal
        TerminalSvc.AddLog($"> DECRYPTING_MANIFEST: {ProjectState.SelectedFile?.ModuleName}...", LogType.Info);

        // 3. Keep the shimmer active for a brief "decryption" period
        await Task.Delay(800);

        isDecrypting = false; // Reveal the clear text
        await InvokeAsync(StateHasChanged);
    }

    private async void TriggerGlitch()
    {
        isGlitched = false; // Turn off animation
        StateHasChanged();

        await Task.Delay(50); // Micro-delay to let the DOM breathe

        isGlitched = true; // Turn animation back on
        await InvokeAsync(StateHasChanged);
    }

    private void CloseFile()
    {
        ProjectState.CloseFile();

        // If we are on a specific project page, kick back to Home
        if (Nav.Uri.Contains("wpfview") || Nav.Uri.Contains("uplink"))
        {
            Nav.NavigateTo("/");
        }

        TerminalSvc.AddLog(">>> SESSION_CLOSED: REDIRECTING_TO_STANDBY", LogType.System);
    }

    private async void HandleProjectSwitch()
    {
        // 1. Force Reset
        activeTab = "SPECS";
        currentCodeBody = "";
        isDecrypting = true;

        // 2. Refresh UI
        await InvokeAsync(StateHasChanged);

        // 3. Shimmer for a bit then stop
        await Task.Delay(800);
        isDecrypting = false;
        await InvokeAsync(StateHasChanged);
    }

    private string GetLanguageClass(string tabLabel)
    {
        // Detects language based on tab name or extension
        if (tabLabel.Contains("XAML", StringComparison.OrdinalIgnoreCase))
            return "language-xml"; // Prism uses 'xml' for XAML/HTML

        return "language-csharp";
    }

    private async Task LoadTab(string label, string url)
    {
        activeTab = label;
        currentCodeBody = "";

        await InvokeAsync(StateHasChanged);

        if (label.Equals("SPECS", StringComparison.OrdinalIgnoreCase))
        {
            currentCodeBody = "";
            activeTab = "SPECS";
            return;
        }
        else
        {
            try
            {
                TerminalSvc.AddLog($"> REQUESTING_SOURCE: {label}...", LogType.Info);

                // 2. Fetch the new data
                var fetchedCode = await Http.GetStringAsync(url);

                // 3. Update the variable
                currentCodeBody = fetchedCode;

                // 4. Notify Blazor to render the NEW code into the DOM
                await InvokeAsync(StateHasChanged);

                // 5. CRITICAL: Wait for the DOM to actually exist before highlighting
                // If we call JS too fast, it highlights nothing.
                await Task.Delay(50);
                await JS.InvokeVoidAsync("Prism.highlightAll");
            }
            catch (Exception ex)
            {
                currentCodeBody = $"// ERROR_ACCESSING_NODE: {ex.Message}";
                await InvokeAsync(StateHasChanged);
            }
        }
 
    }

    private async Task LoadProjectData()
    {
        if (ProjectState.SelectedFile != null && ProjectState.SelectedFile.Extension == ".xaml")
        {
            // Reset content while loading
            xamlContent = "LOADING_SCHEMATIC...";
            StateHasChanged();

            // Fetch the raw XAML text from your wwwroot/data folder
            try
            {
                // Assuming your ProjectStateService or a separate Service handles the HttpClient
                // xamlContent = await Http.GetStringAsync(ProjectState.SelectedFile.SourceUrl);
            }
            catch
            {
                xamlContent = "ERROR: SOURCE_NOT_FOUND";
            }

            StateHasChanged();
        }
    }

    private void LogDownload()
    {
        var fileName = ProjectState.SelectedFile?.FileName ?? "UNKNOWN";
        // Assuming your terminal logic is tied to a method in a service or parent
        Console.WriteLine($">>> INITIATING_SECURE_TRANSFER: {fileName}.zip from remote uplink.");
    }

    public void Dispose()
    {
        ProjectState.OnChange -= HandleProjectSwitch;
    }
}
