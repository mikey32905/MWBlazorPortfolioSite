@page "/wpf-viewer"

@layout PortfolioLayout
@inject ThemeService ThemeSvc
@inject TerminalService TerminalSvc
@inject ProjectStateService ProjectState
@implements IDisposable

<div class="wpf-container">
    <div class="wpf-layout">
        <div class="blueprint-pane">
            <div class="briefing-header">
                <span class="pulse-dot"></span>
                <h4 class="briefing-title">> PROJECT_LOG_SUMMARY</h4>
                @* <h3 class="pane-title">> UI_SCHEMATIC_PREVIEW</h3> *@
            </div>

            <div class="briefing-body">
                @if (ProjectState.SelectedFile?.Description != null && ProjectState.SelectedFile.Description.Any())
                {
                    <div class="glitch-container" @key="ProjectState.SelectedFile.FileName">
                        @foreach (var logEntry in ProjectState.SelectedFile.Description)
                        {
                            <div class="log-row @(isGlitched ? "glitch-text" : "")">
                                <span class="line-prefix">[LOG]:</span>
                                <p class="briefing-text">@logEntry</p>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="briefing-text opacity-50">NO_DESCRIPTION_DATA_RECOVERED...</p>
                }
            </div>
            
            <div class="blueprint-frame">

                @if (!string.IsNullOrEmpty(ProjectState.SelectedFile?.BlueprintUrl))
                {
                    <div class="image-container @(isGlitched ? "glitch-image" : "")">
                        <img src="@ProjectState.SelectedFile.BlueprintUrl" class="blueprint-img" 
                             style="width: 100%; height: auto; display: block;"
                             alt="System Blueprint" />
                    </div>
                }
                else
                {
                    <div class="no-asset-warning">MISSING_VISUAL_ASSET</div>
                }
                
                <div class="scan-overlay"></div>

                <div class="overlay-grid"></div>
            </div>

            <div class="blueprint-metadata">
                @if (ProjectState.SelectedFile?.Metadata != null)
                {
                    @foreach (var entry in ProjectState.SelectedFile.Metadata)
                    {
                        <div class="meta-box">
                            <label>@entry.Key.Replace("_", " ")</label>
                            <span class="glow-text">@entry.Value</span>
                        </div>
                    }
                }
                else
                {
                    <div class="meta-box">
                        <label>STATUS</label>
                        <span>NO_METADATA_AVAILABLE</span>
                    </div>
                }
            </div>

            @if (!string.IsNullOrEmpty(ProjectState.SelectedFile?.GitHubUrl))
            {
                <a href="@ProjectState.SelectedFile.GitHubUrl" target="_blank" class="github-repo-btn">
                    <svg viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" />
                    </svg>
                    <span class="btn-text">ACCESS_FULL_REPOSITORY</span>
                    <span class="btn-subtext">VIEW_SOURCE_ON_GITHUB</span>
                </a>
            }
        </div>

        <div class="xaml-pane">
            <div class="pane-header">
                
                <h3 class="pane-title">> SOURCE_FILES</h3>

                <div class="header-actions">
                    @if (ProjectState.SelectedFile?.SupportingFiles?.Any() == true)
                    {
                        @if (!string.IsNullOrEmpty(ProjectState.SelectedFile?.DownloadUrl))
                        {
                            <a href="@ProjectState.SelectedFile.DownloadUrl"
                               @onclick="LogDownload"
                               target="_blank"
                               class="download-link">
                                <span class="version-tag">@ProjectState.SelectedFile.Version</span>
                                <span class="btn-text">[ GET_EXECUTABLE.EXE ]</span>
                            </a>
                        }

                        <div class="mini-tabs">
                            @foreach (var file in ProjectState.SelectedFile.SupportingFiles)
                            {
                                @* Ensure you are capturing the current 'file' variables correctly *@
                                var tabLabel = file.Key;
                                var tabUrl = file.Value;

                                <button class="tab-btn @(activeTab == tabLabel ? "active" : "")"
                                        @onclick="() => LoadTab(tabLabel, tabUrl)">
                                    @tabLabel
                                </button>
                            }
                        </div>
                    }
                </div>
            </div>

            
            <div class="editor-wrapper">
                <CodeEditorView @key="@(ProjectState.SelectedFile?.FileName + activeTab)" />
            </div>
        </div>
    </div>
</div>

@code {
    private string? xamlContent;

    [Parameter] public ProjectFile Project { get; set; } = new();
    private string activeTab = "XAML";
    private bool isGlitched = true;

    protected override void OnInitialized()
    {
        // Listen for when the HttpClient finishes loading the text
        ProjectState.OnChange += HandleStateChange; ;
    }

    protected override async Task OnInitializedAsync()
    {
        ProjectState.OnChange += async () => await LoadProjectData();
        await LoadProjectData();
    }

    private async void TriggerGlitch()
    {
        isGlitched = false; // Turn off animation
        StateHasChanged();

        await Task.Delay(50); // Micro-delay to let the DOM breathe

        isGlitched = true; // Turn animation back on
        await InvokeAsync(StateHasChanged);
    }

    private void HandleStateChange()
    {
        Console.WriteLine($">>> WPF_VIEWER: State changed. Content length: {ProjectState.SelectedFileContent?.Length ?? 0}");
        // This forces the page to re-render the moment
        // the HttpClient finishes downloading the XAML.
        InvokeAsync(StateHasChanged);
    }

    private async Task LoadTab(string label, string url)
    {
        Console.WriteLine($">>> UI_ACTION: Switching to tab [{label}] - Target: {url}");
        activeTab = label;

        // We call a new helper method in your service to just swap the text
        await ProjectState.UpdateActiveContent(url);

        StateHasChanged();
    }

    private async Task LoadProjectData()
    {
        if (ProjectState.SelectedFile != null && ProjectState.SelectedFile.Extension == ".xaml")
        {
            // Reset content while loading
            xamlContent = "LOADING_SCHEMATIC...";
            StateHasChanged();

            // Fetch the raw XAML text from your wwwroot/data folder
            try
            {
                // Assuming your ProjectStateService or a separate Service handles the HttpClient
                // xamlContent = await Http.GetStringAsync(ProjectState.SelectedFile.SourceUrl);
            }
            catch
            {
                xamlContent = "ERROR: SOURCE_NOT_FOUND";
            }

            StateHasChanged();
        }
    }

    private void LogDownload()
    {
        var fileName = ProjectState.SelectedFile?.FileName ?? "UNKNOWN";
        // Assuming your terminal logic is tied to a method in a service or parent
        Console.WriteLine($">>> INITIATING_SECURE_TRANSFER: {fileName}.zip from remote uplink.");
    }

    public void Dispose()
    {
        ProjectState.OnChange -= StateHasChanged;
    }
}
