@page "/uplink"

@layout PortfolioLayout
@inject TerminalService TerminalSvc
@inject ThemeService ThemeSvc
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject CommunicationService CommsSvc

<div class="uplink-container">
    <div class="identity-header">
        <span class="root-path">SYS://COMM/</span>
        <span class="file-name">SIGNAL_INTERCEPT.io</span>
        <div class="security-clearance">ENCRYPTION: RSA_4096</div>
    </div>

    <div class="uplink-view">
        <div class="nodes-grid">
            @foreach (var link in SocialLinks)
            {
                <div class="node-card @GetNodeClass(link.Name)" @key="link.Name" @onclick="() => HandleNavigation(link)" style="cursor:pointer;">
                    <div class="node-header">
                        <span class="node-icon">@link.Icon</span>
                        <span class="node-title">> @link.Name</span>
                    </div>
                    <div class="node-body">
                        <p class="node-desc">@link.Description</p>
                        <p class="node-path">https://ext.node/@link.Name.ToLower()</p>
                    </div>
                    @* <a href="@link.Url" target="_blank" class="node-action">
                        ESTABLISH_CONNECTION →
                    </a> *@
                </div>
            }
        </div>

        <div class="uplink-separator">
            <div class="line-left"></div>
            <div class="separator-center">
                <span class="pulse-icon"></span>
                <span class="separator-text">INITIATING_DIRECT_COMMS_CHANNEL</span>
            </div>
            <div class="line-right"></div>
        </div>

        <div class="terminal-interface">
            <div class="terminal-header">
                <span class="header-tag">[ COMMS_INPUT ]</span>
                <div class="status-group">
                    <span class="terminal-status">ENCRYPTION: AES-256</span>
                    <span class="terminal-status">SIGNAL: STABLE</span>
                </div>
            </div>

            <div class="terminal-body">
                <div class="input-line">
                    <span class="prompt">GUEST@PORTFOLIO:~$ IDENT_SOURCE --input</span>
                    <input type="text" @bind="contactModel.Name" class="cmd-input" placeholder="ENTER_NAME_OR_EMAIL..." />
                </div>

                <div class="input-line">
                    <span class="prompt">GUEST@PORTFOLIO:~$ SUBJECT_LINE --set</span>
                    <input type="text" @bind="contactModel.Email" class="cmd-input" placeholder="REASON_FOR_CONTACT..." />
                </div>

                <div class="input-line message-line">
                    <span class="prompt">GUEST@PORTFOLIO:~$ MESSAGE_BODY --write</span>
                    <textarea @bind="contactModel.Message" class="cmd-input cmd-textarea" rows="6" placeholder="TYPE_MESSAGE_DATA_HERE..."></textarea>
                </div>

                <div class="action-line">
                    <button @onclick="HandleTransmission" class="transmit-btn @(isLocked ? "locked" : "")">
                        [ EXECUTE_TRANSMISSION ]
                    </button>
                </div>
            </div>
        </div>
    </div>
    @if (isTransmitting)
    {
        <div class="transmission-overlay">
            <div class="overlay-content">
                <div class="glitch-text" data-text="ENCRYPTING_PACKET...">ENCRYPTING_PACKET...</div>
                <div class="progress-container">
                    <div class="progress-fill" style="width: @(transmissionProgress)%"></div>
                </div>
                <div class="status-text">
                    @if (transmissionProgress < 40)
                    {
                        <span>STAGING_DORSAL_BUFFER...</span>
                    }
                    else if (transmissionProgress < 80)
                    {

                        <span>BYPASSING_FIREWALL...</span>
                    }
                    else
                    {

                        <span>SIGNAL_STABILIZED_SENDING...</span>
                    }
                </div>
            </div>
        </div>
    }
</div>


@code {

    private bool isTransmitting = false;
    private string progressDisplay = "";
    private int transmissionProgress = 0;

    private ContactForm contactModel = new();
    private int cooldownSeconds = 0;
    private bool isLocked => cooldownSeconds > 0;

    private List<SocialLink> SocialLinks = new()
    {
        new SocialLink { Name = "GITHUB", Url = "https://github.com/mikey32905", Icon = "📂", Description = "Source repositories & open-source contributions." },
        new SocialLink { Name = "LINKEDIN", Url = "https://www.linkedin.com/in/mike-williams-0511835/", Icon = "🔗", Description = "Professional network & career history." },
        new SocialLink { Name = "TWITTER/X", Url = "https://x.com/mikey32905", Icon = "🐦", Description = "Tech insights & community engagement." },
        new SocialLink { Name = "STACK OVERFLOW", Url = "https://stackoverflow.com/users/608583/mike", Icon = "󰓌", Description = "Problem-solving history & community reputation." },
        new SocialLink { Name = "DISCORD", Url = "https://discordapp.com/users/mikey32905_8675309", Icon = "󰙯", Description = "Real-time technical collaboration & networking." },
        new SocialLink { Name = "DEV_INTEL", Url = "https://mwdevstudio.net/", Icon = "󰖟", Description = "Technical articles, tutorials, and system logs." },
        new SocialLink { Name = "PERSONNEL_DOSSIER", Url = "identity", Icon = "󰦪", Description = "High-priority technical CV & certification manifest." },
        new SocialLink { Name = "COFFEE_UPLINK", Url = "https://buymeacoffee.com/mikey32935", Icon = "󰄬", Description = "Professional endorsements and peer validations." }
    };

    // Helper to assign specific colors to special cards
    private string GetNodeClass(string name) => name switch
    {
        "PERSONNEL_DOSSIER" => "gold-node",
        "INTEL_FEED" => "purple-node",
        "STACK_OVERFLOW" => "orange-node",
        _ => "cyan-node"
    };

    private async Task HandleTransmission()
    {
        if (isLocked || isTransmitting) return;


        if (string.IsNullOrWhiteSpace(contactModel.Name) || string.IsNullOrWhiteSpace(contactModel.Message)) return;

        isTransmitting = true;
        transmissionProgress = 0;

        TerminalSvc.AddLog(">>> INITIATING_UPLINK_PROTOCOL...", LogType.System);

        isTransmitting = true;
        TerminalSvc.AddLog("ENCRYPTING_PACKET...", LogType.Info);

        
        var success = await CommsSvc.SendUplinkMessage(contactModel);

        if (success)
        {
            TerminalSvc.AddLog("DATA_PAYLOAD_SIZE: 124_BYTES", LogType.System);
            TerminalSvc.AddLog("TRANSMISSION_SUCCESSFUL: 200_OK", LogType.Success);

            // Start 60-second cooldown
            cooldownSeconds = 60;
            _ = StartCooldownTimer();

            contactModel = new(); // Clear form
        }
        else
        {
            TerminalSvc.AddLog("TRANSMISSION_ERROR: UPLINK_FAILED", LogType.Error);
        }

        isTransmitting = false;
    }

    private async Task HandleNavigation(SocialLink link)
    {
        // If it's the internal dossier, use the NavManager without a full reload
        if (link.Name == "PERSONNEL_DOSSIER")
        {
            // This keeps the C# state (Login/Projects) alive
            Nav.NavigateTo(Nav.BaseUri + "identity");
        }
        else
        {
            // Open external social links in a new tab
            await JS.InvokeVoidAsync("open", link.Url, "_blank");
        }
    }

    // This method is called by the JavaScript to update the live terminal
    [JSInvokable]
    public static void UpdateTerminalProgress(string progress)
    {
        // You'll need a way to update your terminal service here
        // e.g., TerminalService.CurrentLine = $"PROGRESS: [{progress}]";
    }

    private async Task StartCooldownTimer()
    {
        while (cooldownSeconds > 0)
        {
            await Task.Delay(1000);
            cooldownSeconds--;
            StateHasChanged();
        }
    }

    private void LogHover(string target)
    {
        TerminalSvc.AddLog($"Pinging external node: {target}...", LogType.System);
    }

    private void NotifyTerminal(string platform)
    {
        TerminalSvc.AddLog($"SCANNING_LINK: Initializing handshake with {platform} servers...", LogType.System);
    }
}
