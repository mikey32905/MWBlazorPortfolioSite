@page "/identity"

@layout PortfolioLayout

@inject ProjectStateService ProjectState
@inject TerminalService TerminalSvc
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject HttpClient Http
@inject CommunicationService CommsSvc


@if (ProjectState.SelectedFile == null)
{
    <p>Loading System Profile...</p>
}
else
{
    <div class="identity-layout">

        <div class="identity-grid">

            <div class="identity-main">

                <div class="workspace-pane bio-side">
                    <div class="pane-header">> IDENTITY_DECRYPTION</div>
                    <div class="bio-content">
                        <img src="@($"{Nav.BaseUri}img/portfolioImages/portfolo-pic1(a).jpg")" class="profile-frame" />
                        <div class="bio-text">
                            <h3 class="typewriter-text">MW_OPERATOR</h3>
                            <p class="status-line typewriter-text" style="animation-delay: 1.5s;">> STATUS: ACTIVE_DEVELOPER</p>
                           
                            <p class="decode-fade" style="animation-delay: 3s; margin-top: 15px;">
                                Specializing in full-stack C# architecture and WPF engineering.
                                Passionate about building highly-performant, secure, and
                                tactical user interfaces.
                            </p>
                        </div>
                    </div>
                </div>
 
                <div class="workspace-pane skill-side">
                    <div class="pane-header">> CORE_CAPABILITIES_DIAGNOSTIC</div>
                        <div class="diagnostic-list">
                            @foreach (var skill in MySkills)
                            {
                                <div class="skill-row">
                                    <div class="skill-label">
                                        <span>@skill.Name</span>
                                        <span class="skill-percent">@skill.Value%</span>
                                    </div>
                                    <div class="progress-container">
                                    <div class="progress-bar"
                                         style="--final-width: @(skill.Value)%; background: @skill.Color;"></div>
                                        <div class="progress-glow" style="width: @skill.Value%; box-shadow: 0 0 10px @skill.Color;"></div>
                                    </div>
                                </div>
                            }
                        </div>
                </div>
 
            </div>

            <div class="workspace-pane contact-side">
                  <div class="pane-header">> ESTABLISH_SECURE_UPLINK</div>
                    <div class="terminal-form">
                     <div class="input-line">
                            <span class="prompt">NAME:</span>
                        <input type="text" @bind="contactModel.Name" class="term-input" placeholder="ENTER_NAME..." />
                     </div>
                     <div class="input-line">
                            <span class="prompt">EMAIL:</span>
                        <input type="email" @bind="contactModel.Email" class="term-input" placeholder="ENTER_RETURN_PATH..." />
                     </div>
                     <div class="input-line">
                            <span class="prompt">MESSAGE:</span>
                            <textarea @bind="contactModel.Message" class="term-input" rows="4" placeholder="TRANSMIT_DATA..."></textarea>
                     </div>
                    <button class="transmit-btn @(isTransmitting ? "loading" : "")" @onclick="HandleTransmission">EXECUTE_TRANSMISSION</button>
                    </div>
             </div>
        </div>
       
    </div>

    <div class="footer-spacer" style="height: 150px;"></div>

}


@code {
    [Parameter] public ProjectFile Project { get; set; } = new();
    private ProjectFile? identityFile;
    private bool isFlipped = false;
    private System.Timers.Timer? flipTimer;

    private ContactForm contactModel = new();
    private bool isTransmitting = false;
    private int cooldownSeconds = 0;
    private bool isLocked => cooldownSeconds > 0;

    private List<SkillItem> MySkills = new()
    {
        new SkillItem("C#_DOTNET", 95, "#00F3FF"),
        new SkillItem("BLAZOR_WASM", 90, "#BC13FE"),
        new SkillItem("WPF_MVVM", 85, "#FFD700"),
        new SkillItem("SQL_DATABASE", 80, "#00FF41"),
        new SkillItem("REST_API_INT", 88, "#FF3E3E")
    };

    public record SkillItem(string Name, int Value, string Color);

    private List<string> displayedLogs = new();
    private string[] fullLogs = {
    "> [INIT] CORE_DRIVERS_LOADED... OK",
    "> [SCAN] MEMORY_INTEGRITY... 100%",
    "> [AUTH] USER_RECOGNIZED: MICHAEL_W",
    "> [STATUS] IDENTITY_PROXIMITY_SENSORS_ACTIVE",
    "> [READY] AWAITING_COMMAND..."
};

    private async Task HandleResumeDownload()
    {
        // 1. Play the "Hacker" role in the terminal
        TerminalSvc.AddLog("INITIATING_SECURE_EXTRACT...", LogType.System);
        await Task.Delay(800);

        TerminalSvc.AddLog("BYPASSING_ENCRYPTION_LAYERS...", LogType.Warning);
        await Task.Delay(600);

        // 2. Trigger the actual browser download
        // Ensure your resume is at wwwroot/data/resume.pdf
        await JS.InvokeVoidAsync("open", "data/resume.pdf", "_blank");

        TerminalSvc.AddLog("EXTRACT_SUCCESSFUL: Local copy generated.", LogType.Success);
    }

    // Ensure this component re-renders if the state changes
    protected override void OnInitialized()
    {
        // Log the re-entry into the system logs
        TerminalSvc.AddToTerminal(">>> RECOGNIZED_USER: MICHAEL_W // IDENTITY_MODULE_MOUNTED");

        // Find the identity file in the service
        var identityFile = ProjectState.ProjectFiles
            .FirstOrDefault(f => f.FileName.Equals("Identity", StringComparison.OrdinalIgnoreCase));


        // Option B: Manual fallback if manifest isn't loaded yet
        if (identityFile == null)
        {
            Console.WriteLine("DEBUG: Identity file not found in ProjectState list.");
        }
        else
        {
            // Highlight this file in the sidebar even if we arrived here via URL
            ProjectState.SelectFile(identityFile);
        }

        ProjectState.OnChange += StateHasChanged;

        // Flip every 4 seconds (matching the scan-move animation duration)
        flipTimer = new System.Timers.Timer(4000);
        flipTimer.Elapsed += (s, e) =>
        {
            isFlipped = !isFlipped;
            InvokeAsync(StateHasChanged);
        };
        flipTimer.AutoReset = true;
        flipTimer.Enabled = true;
    }

    protected override async Task OnInitializedAsync()
    {
        displayedLogs.Clear();
        foreach (var line in fullLogs)
        {
            displayedLogs.Add(line);
            StateHasChanged();
            await Task.Delay(200); // Faster typing feels more "system-like"
        }

        // 1. Ensure the service actually has the files loaded
        if (ProjectState.ProjectFiles == null)
        {
            await ProjectState.InitializeAsync(Http);
        }

        // 2. Find the file
        identityFile = ProjectState.ProjectFiles?
            .FirstOrDefault(f => f.FileName.Equals("Identity", StringComparison.OrdinalIgnoreCase));

        // 3. IMPORTANT: Tell the service this is the active file
        // This is what makes the CLOSE_SESSION button appear in the Layout!
        if (identityFile != null)
        {
            ProjectState.SelectFile(identityFile);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Short delay to let the typewriter animation start first
            await Task.Delay(500);
            TerminalSvc.AddLog("DECRYPTING_IDENTITY_CORE...", LogType.Info);

            await Task.Delay(1500);
            TerminalSvc.AddLog("IDENTITY_DECRYPTED: ACCESS_GRANTED", LogType.Success);

            // Add a 'System' or 'Neural' log type that uses your current gold accent (#FFD700)
            TerminalSvc.AddLog(">>> RECOGNIZED_USER: MICHAEL_W // IDENTITY_MODULE_MOUNTED", LogType.Success);

            // Triggers the terminal to scroll to the bottom
            StateHasChanged();
        }
    }

    private async Task HandleTransmission()
    {
        if (isLocked || isTransmitting) return;

        TerminalSvc.AddLog("DATA_PACKET_QUEUED...", LogType.Info);
        TerminalSvc.AddLog("TRANSMITTING_VIA_SECURE_TUNNEL...", LogType.Warning);

        if (string.IsNullOrWhiteSpace(contactModel.Email) || isTransmitting) return;

        isTransmitting = true;
        TerminalSvc.AddLog("ENCRYPTING_PACKET...", LogType.Info);

        // var templateParams = new
        // {
        //     from_name = contactModel.Name,
        //     reply_to = contactModel.Email,
        //     message = contactModel.Message
        // };

        // Call the JS function we created in step 2
        // var success = await JS.InvokeAsync<bool>("sendEmail",
        //     "service_lcjfrme",
        //     "template_wxstuk8",
        //     templateParams);
        var success = await CommsSvc.SendUplinkMessage(contactModel);

        if (success)
        {
            TerminalSvc.AddLog("TRANSMISSION_SUCCESSFUL: 200_OK", LogType.Success);

            // Start 60-second cooldown
            cooldownSeconds = 60;
            _ = StartCooldownTimer();

            contactModel = new(); // Clear form
        }
        else
        {
            TerminalSvc.AddLog("TRANSMISSION_ERROR: UPLINK_FAILED", LogType.Error);
        }

        isTransmitting = false;
    }

    private async Task StartCooldownTimer()
    {
        while (cooldownSeconds > 0)
        {
            await Task.Delay(1000);
            cooldownSeconds--;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        ProjectState.OnChange -= StateHasChanged;
    }
}
