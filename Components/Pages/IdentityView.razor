@page "/identity"

@layout PortfolioLayout

@inject ProjectStateService ProjectState
@inject TerminalService TerminalSvc
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject HttpClient Http


@if (ProjectState.SelectedFile == null)
{
    <p>Loading System Profile...</p>
}
else
{
    <div class="identity-dossier" style="display: flex; flex-direction: column; height: 100vh; padding-top: 60px;">
        <div class="identity-header"> ... </div>
        
        <div class="identity-grid">
            <div class="system-stats-col">
                <div class="photo-module">
                    <div class="photo-frame">
                        <div class="scan-line"></div>
                        <img src="@($"{Nav.BaseUri}img/portfolioImages/portfolo-pic1(a).jpg")" alt="Neural Signature" />
                    </div>
                    <div class="stat-indicators">
                        <p>LOGIC_PROCESSING <span class="force-blink" style="color: #FFD700;">[ACTIVE]</span></p>
                        <p>CREATIVE_ENGINE <span class="blink-slow">[STABLE]</span></p>
                        <p>SYSTEM_STAMINA <span class="blink-fast">[98%]</span></p>
                    </div>
                </div>

                <div class="trace-module">
                    <div class="trace-header">LIVE_SYSTEM_TRACE</div>
                    <div class="trace-body">
                        @foreach (var log in displayedLogs)
                        {
                            <p class="trace-line">
                                <span class="timestamp">[@DateTime.Now.ToString("HH:mm:ss")]</span> @log
                            </p>
                        }
                    </div>
                </div>
            </div> <div class="data-pane">
                <h3 class="pane-title">> RAW_SOURCE_DATA</h3>
                <div class="code-overlay-container">
                    @if (ProjectState.SelectedFile != null)
                    {
                        <div class="transparent-editor">
                            <CodeEditorView SelectedFile="ProjectState.SelectedFile" />
                        </div>
                    }
                </div>
            </div>

            <div class="spec-pane">
                <div class="spec-box">
                    <label>CURRENT_LOCATION</label>
                    <p>[REDACTED] / EARTH</p>
                </div>
                <div class="spec-box">
                    <label>PRIMARY_LANGUAGE</label>
                    <p>C# / TYPESCRIPT / ENGLISH</p>
                </div>
                <div class="spec-box highlight">
                    <label>CORE_DIRECTIVE</label>
                    <p>BUILD_BETTER_SYSTEMS</p>
                </div>
            </div>
        </div>

    </div>



}


@code {
    [Parameter] public ProjectFile Project { get; set; } = new();
    private ProjectFile? identityFile;
    private bool isFlipped = false;
    private System.Timers.Timer? flipTimer;

    private List<string> displayedLogs = new();
    private string[] fullLogs = {
    "> [INIT] CORE_DRIVERS_LOADED... OK",
    "> [SCAN] MEMORY_INTEGRITY... 100%",
    "> [AUTH] USER_RECOGNIZED: MICHAEL_W",
    "> [STATUS] IDENTITY_PROXIMITY_SENSORS_ACTIVE",
    "> [READY] AWAITING_COMMAND..."
};

    private async Task HandleResumeDownload()
    {
        // 1. Play the "Hacker" role in the terminal
        TerminalSvc.AddLog("INITIATING_SECURE_EXTRACT...", LogType.System);
        await Task.Delay(800);

        TerminalSvc.AddLog("BYPASSING_ENCRYPTION_LAYERS...", LogType.Warning);
        await Task.Delay(600);

        // 2. Trigger the actual browser download
        // Ensure your resume is at wwwroot/data/resume.pdf
        await JS.InvokeVoidAsync("open", "data/resume.pdf", "_blank");

        TerminalSvc.AddLog("EXTRACT_SUCCESSFUL: Local copy generated.", LogType.Success);
    }

    // Ensure this component re-renders if the state changes
    protected override void OnInitialized()
    {
        // Log the re-entry into the system logs
        TerminalSvc.AddToTerminal(">>> RECOGNIZED_USER: MICHAEL_W // IDENTITY_MODULE_MOUNTED");

        // Find the identity file in the service
        var identityFile = ProjectState.ProjectFiles
            .FirstOrDefault(f => f.FileName.Equals("Identity", StringComparison.OrdinalIgnoreCase));


        // Option B: Manual fallback if manifest isn't loaded yet
        if (identityFile == null)
        {
            Console.WriteLine("DEBUG: Identity file not found in ProjectState list.");
        }
        else
        {
            // Highlight this file in the sidebar even if we arrived here via URL
            ProjectState.SelectFile(identityFile);
        }

        ProjectState.OnChange += StateHasChanged;

        // Flip every 4 seconds (matching the scan-move animation duration)
        flipTimer = new System.Timers.Timer(4000);
        flipTimer.Elapsed += (s, e) =>
        {
            isFlipped = !isFlipped;
            InvokeAsync(StateHasChanged);
        };
        flipTimer.AutoReset = true;
        flipTimer.Enabled = true;
    }

    protected override async Task OnInitializedAsync()
    {
        displayedLogs.Clear();
        foreach (var line in fullLogs)
        {
            displayedLogs.Add(line);
            StateHasChanged();
            await Task.Delay(200); // Faster typing feels more "system-like"
        }

        // 1. Ensure the service actually has the files loaded
        if (ProjectState.ProjectFiles == null)
        {
            await ProjectState.InitializeAsync(Http);
        }

        // 2. Find the file
        identityFile = ProjectState.ProjectFiles?
            .FirstOrDefault(f => f.FileName.Equals("Identity", StringComparison.OrdinalIgnoreCase));

        // 3. IMPORTANT: Tell the service this is the active file
        // This is what makes the CLOSE_SESSION button appear in the Layout!
        if (identityFile != null)
        {
            ProjectState.SelectFile(identityFile);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Clear any existing logs to prevent duplication
            displayedLogs.Clear();

            foreach (var line in fullLogs)
            {
                displayedLogs.Add(line);
                StateHasChanged(); // Force re-render
                await Task.Delay(400);
            }
        }
    }


    public void Dispose()
    {
        ProjectState.OnChange -= StateHasChanged;
    }
}
