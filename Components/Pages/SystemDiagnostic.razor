@page "/system-diagnostic"

@layout PortfolioLayout
@inject TerminalService TerminalSvc
@inject ThemeService ThemeSvc
@implements IDisposable
@inject ProjectStateService ProjectState
@inject ProjectManifestService ManifestSvc
@inject IJSRuntime JSRuntime
@inject NavigationManager Nav

<div class="diag-container">
    <div class="diag-header">
        <div class="header-main">
            <h1 class="glitch-title">SYSTEM_DIAGNOSTICS_V4.0</h1>
            <div class="uptime-group">
                <div class="uptime-counter">UPTIME: <span class="glow-text">@UptimeString</span></div>

                <div class="session-info">
                    <span class="label">SESSION_ACTIVE:</span>
                    <span class="cyan-glow">@_sessionTime</span>

                    <div class="connection-uplink">
                        <span class="label">UPLINK:</span>
                        <div class="signal-bars">
                            @for (int i = 1; i <= 5; i++)
                            {
                                <div class="bar @(i <= GetBarCount() ? "active" : "")"></div>
                            }
                        </div>
                        <span class="percent">@(_connectionStrength)%</span>
                    </div>
                </div>
            </div>
         </div>
        
        <div class="header-telemetry">
            <div class="core-load-group">
                <div class="core-item">
                    <label>CORE_01</label>
                    <div class="mini-bar"><div class="fill" style="width: @(CpuLoad)%"></div></div>
                </div>
                <div class="core-item">
                    <label>CORE_02</label>
                    <div class="mini-bar"><div class="fill" style="width: @(Math.Clamp(CpuLoad + 5, 0, 100))%"></div></div>
                </div>
                <div class="core-item">
                    <label>CORE_03</label>
                    <div class="mini-bar"><div class="fill" style="width: @(Math.Clamp(CpuLoad - 12, 0, 100))%"></div></div>
                </div>
            </div>
            <div class="load-percentage">@CpuLoad% AVG_LOAD</div>
        </div>
    </div>

    <div class="circuit-view">
        <h3 class="pane-title">> NEURAL_DEPENDENCY_MAP</h3>
        <div class="circuit-board">
            <svg class="circuit-svg">
                <path d="M 450 150 L 150 80" class="trace-line" />
                <path d="M 450 150 L 750 80" class="trace-line" />
                <path d="M 450 150 L 150 220" class="trace-line" />
                <path d="M 450 150 L 750 220" class="trace-line" />
            </svg>

            <div class="node core-hub">
                <div class="hub-text">C# / .NET 9/10</div>
                <div class="sub-label">CORE_PROCESSOR</div>
            </div>

            <div class="node satellite" style="top: 40px; left: 20px;">BLAZOR_WASM</div>
            <div class="node satellite" style="top: 40px; right: 20px;">WPF_XAML</div>
            <div class="node satellite" style="bottom: 40px; left: 20px;">SQL_SERVER</div>
            <div class="node satellite" style="bottom: 40px; right: 20px;">AZURE_CLOUD</div>
        </div>
    </div>

    <div class="diag-grid">
        <div class="diag-card wide">
            <h3 class="pane-title">> NEURAL_SKILL_FREQUENCIES</h3>
            <div class="skill-telemetry">
                <div class="skill-row">
                    <label>C_SHARP / .NET</label>
                    <div class="wave-container">
                        <svg class="wave" viewBox="0 0 100 20"><path d="M0 10 Q 5 0, 10 10 T 20 10 T 30 10 T 40 10 T 50 10 T 60 10 T 70 10 T 80 10 T 90 10 T 100 10" stroke="#FFD700" fill="transparent" /></svg>
                    </div>
                    <span class="percentage">95%</span>
                </div>
                <div class="skill-row">
                    <label>BLAZOR_WASM</label>
                    <div class="wave-container">
                        <svg class="wave fast" viewBox="0 0 100 20"><path d="M0 10 Q 5 0, 10 10 T 20 10 T 30 10 T 40 10 T 50 10 T 60 10 T 70 10 T 80 10 T 90 10 T 100 10" stroke="#00F3FF" fill="transparent" /></svg>
                    </div>
                    <span class="percentage">90%</span>
                </div>
            </div>
        </div>

        <div class="diag-card">
            <h3 class="pane-title">> CORE_UTILIZATION</h3>
            <div class="radial-stats">
                <div class="stat-main">
                    <span class="stat-value">@ManifestSvc.Projects.Count</span>
                    <span class="stat-label">TOTAL_ACTIVE_MODULES</span>
                </div>
                <div class="ring-container">
                    <div class="ring" style="--p:85;--c:#00F3FF;">85% WEB_DEPLOYMENTS</div>
                    <div class="ring" style="--p:60;--c:#FFD700;">60% WPF_DESKTOP_NODES</div>
                </div>
            </div>
        </div>
 
        @* --- NEW NEURAL_MEMORY_STATE CARD --- *@
        <div class="diag-card neural-memory-node">
            <h3 class="pane-title">> NEURAL_MEMORY_STATE</h3>
            <div class="util-content">
                <div class="stat-main">
                    @* This uses the helper method we discussed earlier *@
                    <span class="stat-value">@ManifestSvc.GetFormattedNeuralWeight()</span>
                    <span class="stat-label">TOTAL_LOC_WEIGHT</span>
                </div>
                <div class="memory-buffer">
                    <div class="buffer-label">
                        COMPLEXITY_INDEX: <span style="color: #BC13FE;">@ManifestSvc.GetSystemComplexityScore()</span>
                    </div>
                    <div class="buffer-bar">
                        <div class="buffer-fill" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="diag-card spec-list">
            <h3 class="pane-title">> HARDWARE_MANIFEST</h3>
            <div class="spec-table">
                <div class="spec-item"><span class="label">OS_KERNEL:</span> <span class="val">BLAZOR_WASM_9.0</span></div>
                <div class="spec-item"><span class="label">CORES:</span> <span class="val">C#_14_UNLOCKED</span></div>
                <div class="spec-item"><span class="label">RENDER_ENGINE:</span> <span class="val">CSS3_NEON_GRID</span></div>
                <div class="spec-item"><span class="label">STATE_SYNC:</span> <span class="val">ACTIVE_BROADCAST</span></div>
                <div class="spec-item"><span class="label">ENCRYPTION:</span> <span class="val">AES_256_NEURAL</span></div>
            </div>

            <div class="action-zone">
                <button class="broadcast-btn" @onclick="NavigateToUplink">
                    <span class="btn-glitch">INITIATE_REMOTE_UPLINK</span>
                </button>
            </div>
        </div>

        <div class="diag-card system-log">
            <h3 class="pane-title">> LIVE_SYSTEM_LOG</h3>

            <div class="cpu-monitor">
                <svg viewBox="0 0 36 36" class="circular-chart">
                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <path class="circle" stroke-dasharray="@($"{CpuLoad}, 100")" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <text x="18" y="20.35" class="percentage">@CpuLoad%</text>
                    <text x="18" y="28" class="label">NEURAL_LOAD</text>
                </svg>
            </div>

            <div class="log-stream" @ref="_logContainer">
                @foreach (var log in _logs)
                {
                    <div class="log-entry">
                        <span class="timestamp">[@DateTime.Now.ToString("HH:mm:ss")]</span>
                        <span class="message">@log</span>
                    </div>
                }
            </div>
        </div>
    
    </div>

</div>

<div class="scroll-prompt">
    <div class="mouse-icon">
        <div class="wheel"></div>
    </div>
    <span class="prompt-text">SCROLL_FOR_TELEMETRY</span>
</div>


@code {
    private List<ProjectFile> ProjectFiles = new(); 
    private string UptimeString = "00:00:00";
    private int CpuLoad = 42;
    private int _connectionStrength = 95; 
    private string _sessionTime = "00:00:00";
    private DateTime _startTime = DateTime.Now;
    private Random _rng = new Random();

    private Timer? _timer;
    private Timer? logTimer;
    private Timer? cpuTimer;
    private System.Threading.Timer? _sessonTimer;

    private ElementReference _logContainer;
    private int _previousLogCount = 0;

    private List<string> _logs = new() { "System initialized.", "Neural link established." };
    private string[] _randomMsgs = {
        "Scanning network ports...", "Optimizing WASM memory...",
        "Uplink heartbeat stable.", "Syncing project data cores...",
        "Bypassing security protocols...", "Resource allocation optimized."
    };

    private void NavigateToUplink()
    {
        // Verification log
        Console.WriteLine("Navigating to Uplink...");

        // Add to your terminal service
        TerminalSvc.AddToTerminal(">>> SECURE_LINE_REQUESTED...");
        TerminalSvc.AddToTerminal(">>> REDIRECTING_TO_UPLINK_MODULE...");

        // 1. Find the Uplink file in your ProjectState
        // (Assuming your files are stored in a list in ProjectState)
        var uplinkFile = ProjectState.ProjectFiles.FirstOrDefault(f => f.FileName == "Uplink");

        if (uplinkFile != null)
        {
            // 2. This tells the ProjectState to update, which the Sidebar is likely listening to
            ProjectState.SelectFile(uplinkFile);

            // 3. Update the theme color to match Uplink's accent
            ThemeSvc.UpdateTheme(uplinkFile.AccentColor);
        }

        // 4. Perform the actual navigation
        TerminalSvc.AddLog(">>> SECURE_LINE_REQUESTED...", LogType.System);
        Nav.NavigateTo("uplink");
    }

    protected override void OnInitialized()
    {
        // Simple uptime logic starting from a fixed date (your career start)
        var startDate = new DateTime(2018, 1, 1);
        _timer = new Timer(_ =>
        {
            var diff = DateTime.Now - startDate;
            UptimeString = $"{(int)diff.TotalDays}d:{diff.Hours}h:{diff.Minutes}m:{diff.Seconds}s";
            InvokeAsync(StateHasChanged);
        }, null, 0, 1000);

        // Timer for log updates
        logTimer = new Timer(_ =>
        {
            var msg = _randomMsgs[new Random().Next(_randomMsgs.Length)];
            _logs.Insert(0, msg); // Newest on top
            if (_logs.Count > 8) _logs.RemoveAt(8); // Keep it tidy
            InvokeAsync(StateHasChanged);
        }, null, 1000, 3000);

        // Timer to fluctuate CPU load
        cpuTimer = new Timer(_ =>
        {
            // Randomly swing load between 40% and 85%
            CpuLoad = new Random().Next(40, 86);
            InvokeAsync(StateHasChanged);
        }, null, 0, 2000);

        _sessonTimer = new System.Threading.Timer(_ =>
        {
            var elapsed = DateTime.Now - _startTime;
            _sessionTime = elapsed.ToString(@"hh\:mm\:ss");
            
            // Randomly fluctuate connection between 88 and 100
            _connectionStrength = _rng.Next(88, 101); 
          
            InvokeAsync(StateHasChanged);
        }, null, 0, 1000);

        // Subscribe to state changes
        ProjectState.OnChange += HandleStateChange;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Every time the component re-renders with a new log,
        // we jump the scroll to the bottom. 
        try
        {
            _previousLogCount = _logs.Count;
            await ScrollToBottom();
        }
        catch
        {
            
        }

        if (firstRender)
        {
            // Attach a simple JS listener to hide the prompt on scroll
            await JSRuntime.InvokeVoidAsync("eval", @"
            window.addEventListener('scroll', () => {
                const prompt = document.getElementById('scrollPrompt');
                if (prompt) {
                    // Hide when scrolled more than 100px
                    if (window.scrollY > 100) {
                        prompt.style.opacity = '0';
                        prompt.style.visibility = 'hidden';
                    } else {
                        prompt.style.opacity = '0.8';
                        prompt.style.visibility = 'visible';
                    }
                }
            }, { passive: true });
        ");
        }
    }

    private void HandleStateChange()
    {
        // If the user closed the session, the service event fires.
        // We call StateHasChanged to ensure the UI stays in sync.
        InvokeAsync(StateHasChanged);
    }

    private int GetBarCount() => _connectionStrength switch
    {
        > 98 => 5,
        > 95 => 4,
        > 92 => 3,
        _ => 2
    };

    private async Task ScrollToBottom()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("scrollToBottom", _logContainer);
        }
        catch (Exception ex)
        {
            // Silent catch for pre-rendering or JS isolation edge cases
            Console.WriteLine($"Scroll Error: {ex.Message}");
        }
    }

    public void Dispose()
    {
        // Essential: Unsubscribe so the timer doesn't run in the background
        _timer?.Dispose();
        // Make sure to dispose of the new log and cpu timers too!
        logTimer?.Dispose();
        cpuTimer?.Dispose(); 
        _sessonTimer?.Dispose();
        ProjectState.OnChange -= HandleStateChange;
    }
}
