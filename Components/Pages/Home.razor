@page "/"

@layout PortfolioLayout
@inject ProjectStateService ProjectState
@inject TerminalService TerminalSvc
@inject NavigationManager Nav
@implements IDisposable

<PageTitle>Home</PageTitle>

 <div class="stage-wrapper">
  @if (ProjectState.SelectedFile == null)
    {
        <div class="welcome-container">
            <div class="scan-grid"></div>

            <div class="boot-content">
                <h1 class="glitch-title" data-text="NEURAL_LINK_ESTABLISHED">NEURAL_LINK_ESTABLISHED</h1>

                <div class="terminal-loader">
                    <p class="typing-text">> ACCESSING_PROTECTED_DATA_CORES...</p>
                    <p class="typing-text">> DECRYPTING_BIOMETRIC_SIGNATURES... <span class="status-ok">DONE</span></p>
                    <p class="typing-text">> LOADING_PORTFOLIO_OS_V4.2.0...</p>
                </div>

                <div class="action-prompt">
                    <span class="pulse-icon">▲</span> SELECT_FILE_FROM_SIDEBAR_TO_INITIALIZE
                </div>
            </div>

            <div class="corner-top-right">V.88-01</div>
            <div class="corner-bottom-left">SECURE_CONNECTION_ENCRYPTED</div>
        </div>
    }
    else
    {
        @* The @key="ProjectState.SelectedFile.FileName" is the magic fix here *@
         <div class="editor-container" @key="ProjectState.SelectedFile.FileName">
            <CodeEditorView SelectedFile="ProjectState.SelectedFile" />
        </div>

    }
</div>  

@code {
 

    // This method runs every time the Sidebar calls SelectFile
    private void HandleStateChanged()
    {
        // This forces THIS component to refresh its HTML
        InvokeAsync(StateHasChanged);
    }

   protected override void OnInitialized()
    {
        // Check if it's a fresh session so we don't spam them on every navigation
        if (!TerminalSvc.Logs.Any())
        {
            TerminalSvc.AddLog("SYSTEM_READY. TYPE 'HELP' FOR AVAILABLE COMMANDS.", LogType.Success);
        }

        // Listen for system reset requests from the TerminalService
        TerminalSvc.OnNavigationRequest += HandleStandardNav;
    }

    private void HandleStandardNav(string path)
    {
        Nav.NavigateTo(path);
    }

    public void Dispose()
    {
      //  TerminalService.OnSystemResetRequested -= InitiateReboot;
        TerminalSvc.OnNavigationRequest -= HandleStandardNav;
    }

}

