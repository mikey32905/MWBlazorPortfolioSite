@using System.Text
@inject TerminalService TerminalSvc
@inject ProjectStateService ProjectState
@inject HttpClient Http
@inject IJSRuntime JS
@implements IDisposable

<div class="editor-wrapper">
    @if (ProjectState.SelectedFileContent != null)
    {
        <pre><code class="language-xaml">@ProjectState.SelectedFileContent</code></pre>
    }
    else
    {
        <div class="loading-overlay">
            <span class="pulse">LOADING_ENCRYPTED_SOURCE...</span>
        </div>
    }
</div>

<div class="editor-container">
    @if (ProjectState.SelectedFileContent != null)
    {
        @* Wrap the code in a dedicated scroll-box *@
        <div class="code-viewport">
            <pre><code>@ProjectState.SelectedFileContent</code></pre>
        </div>
    }
    else if (ProjectState.SelectedFile != null)
    {
        @* Show a tiny loading indicator instead of large text to avoid layout shifts *@
        <div class="loading-bar-mini"></div>
    }
    else
    {
        <div class="no-file-ghost">NO_FILE_SELECTED</div>
    }
</div>


@code {
    [Parameter] public ProjectFile SelectedFile { get; set; }

    // This is the "Safety Net" that prevents the VS 2026 crash
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? UnmatchedParameters { get; set; }

    // Add this one as an "Alias" to catch the Identity.cs call
    [Parameter] public ProjectFile Project { get; set; }
    private string? FileContent;

    private string HighlightedCode = "";
    private int LineCount = 1;

    protected override async Task OnParametersSetAsync()
    {
        // 1. Guard against nulls
        if (SelectedFile == null || string.IsNullOrEmpty(SelectedFile.PhysicalPath))
        {
            FileContent = "NO_FILE_SELECTED";
            return;
        }

        try
        {
            // 2. Clear old text so the user sees it's working
            FileContent = "LOADING_SOURCE...";
            StateHasChanged();

            // 3. Fetch the new file
            // Note: Adding a timestamp (?v=) helps bypass GitHub's cache during testing
            var versionedPath = $"{SelectedFile.PhysicalPath}?v={DateTime.Now.Ticks}";
            FileContent = await Http.GetStringAsync(versionedPath);

            StateHasChanged();

            // 4. Trigger the JS Highlighting
            // We wait a tiny bit to ensure the HTML has rendered the new text
            await Task.Delay(100);
            await JS.InvokeVoidAsync("applyHighlighting", "highlight-target");
        }
        catch (Exception ex)
        {
            FileContent = $"SYSTEM_ERROR: Could not load {SelectedFile.PhysicalPath}. Check GitHub case-sensitivity.";
            StateHasChanged();
        }
    }

     public void Dispose() { }
}
