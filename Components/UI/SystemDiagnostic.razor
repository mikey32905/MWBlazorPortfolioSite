@implements IDisposable

<div class="diag-container">
    <div class="diag-header">
        <h2>SYSTEM_INTEGRITY_REPORT</h2>
        <div class="status-badge @(isStable ? "stable" : "warning")">
            @(isStable ? "SYSTEM_OPTIMAL" : "STABILITY_CHECK_REQUIRED")
        </div>
    </div>

    <div class="diag-grid">
        <div class="diag-card">
            <label>HEAP_ALLOCATION</label>
            <div class="big-value">@allocatedMemory.ToString("N2") MB</div>
            <div class="diag-graph">
                @foreach (var point in memoryHistory)
                {
                    <div class="bar" style="height: @(point)%"></div>
                }
            </div>
        </div>

        <div class="diag-card">
            <label>CLR_VERSION</label>
            <div class="value">.NET 9.0.0-WASM</div>

            <label>GC_GENERATION</label>
            <div class="value">GEN_@GC.GetGeneration(this)</div>

            <label>ACTIVE_COMPONENTS</label>
            <div class="value">@activeComponentCount</div>
        </div>
    </div>

    <div class="log-output">
        <div class="log-label">INTERNAL_EVENT_STREAM</div>
        @foreach (var log in diagLogs)
        {
            <div class="log-line">[@DateTime.Now.ToString("HH:mm:ss.fff")] @log</div>
        }
    </div>
</div>

@code {
    private double allocatedMemory;
    private List<int> memoryHistory = new();
    private List<string> diagLogs = new();
    private bool isStable = true;
    private int activeComponentCount = 12; // Static for demo
    private System.Threading.Timer? _timer;

    protected override void OnInitialized()
    {
        _timer = new System.Threading.Timer(_ =>
        {
            RunDiagnostic();
            InvokeAsync(StateHasChanged);
        }, null, 0, 1500);
    }

    private void RunDiagnostic()
    {
        // Real .NET Memory Check
        allocatedMemory = GC.GetTotalMemory(false) / 1024.0 / 1024.0;

        // Update History for Graph
        memoryHistory.Add((int)(allocatedMemory % 100));
        if (memoryHistory.Count > 30) memoryHistory.RemoveAt(0);

        // Simulated event logs
        if (memoryHistory.Count % 5 == 0)
            diagLogs.Insert(0, $"GC_COLLECTION_PUSH: Memory at {allocatedMemory:N2}MB");

        if (diagLogs.Count > 8) diagLogs.RemoveAt(8);
    }

    public void Dispose() => _timer?.Dispose();
}
