@inject ThemeService ThemeSvc
@inject TerminalService TerminalSvc
@inject ProjectStateService ProjectState
@inject ProjectManifestService Manifest

<div class="sidebar-explorer">
    <div class="sidebar-header">EXPLORER</div>

    <div class="file-tree">
        @if (ProjectState.ProjectFiles == null)
        {
            <div class="sidebar-loading">INITIALIZING_FILESYSTEM...</div>
        }
        else
        {
            @foreach (var categoryGroup in ProjectState.ProjectFiles.GroupBy(f => f.Category))
            {
                var category = categoryGroup.Key;
                bool isOpen = expandedCategories.Contains(category);

                <div class="folder-section">
                    @* Toggle folder state on click *@
                    <div class="folder-header" @onclick="() => ToggleFolder(category)" style="cursor: pointer;">
                        <span class="folder-arrow">@(isOpen ? "▼" : "▶")</span>
                        <span class="folder-icon">@(isOpen ? "📂" : "📁")</span>
                        <span class="folder-name">@category</span>
                    </div>

                    @if (isOpen)
                    {
                        <div class="folder-content">
                            @foreach (var file in categoryGroup)
                            {
                                <div class="file-item @(ProjectState.SelectedFile == file ? "active" : "")"
                                     @onclick="() => ProjectState.SelectFile(file)">
                                    <span class="file-icon" style="color: @file.AccentColor">@file.Icon</span>
                                    <span class="file-name">@file.FileName@file.Extension</span>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        }
    </div>
   
</div>


@code {
    // Stores the names of the folders that are currently expanded
    private HashSet<string> expandedCategories = new();
    
    private ProjectFile? SelectedFile;

    [Parameter] public EventCallback<ProjectFile> OnFileSelected { get; set; }

    private bool IsSelected(ProjectFile file) =>
        ProjectState.SelectedFile?.FileName == file.FileName;
   

    protected override void OnInitialized()
    {
        // Optional: Start with all folders expanded
        if (ProjectState.ProjectFiles != null)
        {
            foreach (var cat in ProjectState.ProjectFiles.Select(f => f.Category).Distinct())
            {
                expandedCategories.Add(cat);
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // If the data hasn't arrived yet, exit gracefully
        if (ProjectState.ProjectFiles == null || !ProjectState.ProjectFiles.Any())
        {
            return;
        }

        foreach (var cat in ProjectState.ProjectFiles.Select(f => f.Category).Distinct())
        {
            if (!expandedCategories.Contains(cat))
            {
                expandedCategories.Add(cat);
            }
        }
    }

    private void ToggleFolder(string category)
    {
        if (expandedCategories.Contains(category))
        {
            expandedCategories.Remove(category);
        }
        else
        {
            expandedCategories.Add(category);
        }
    }

    private async Task HandleFileClick(ProjectFile file)
    {
        ProjectState.SelectFile(file);
        // 1. Update the global site glow
        ThemeSvc.UpdateTheme(file.AccentColor);
        TerminalSvc.AddLog($"MOUNTING_MODULE: {file.FileName.ToUpper()}", LogType.System);

        // 2. Log the action to your new Terminal Service
        TerminalSvc.AddLog($"Loading module: {file.FileName}{file.Extension}...", LogType.System);
        TerminalSvc.AddLog($"Setting environment accent to {file.AccentColor}.", LogType.Success);

        // 3. (Optional) Navigate or Update Main Stage
        ProjectState.SelectFile(file); // This is where the variable is "Set"

        if (file.Extension == ".link")
        {
            TerminalSvc.AddLog("WARNING: Establishing unencrypted bridge to external nodes...", LogType.Warning);
            TerminalSvc.AddLog("UPLINK_PROTOCOL: Active.", LogType.Success);
        }
        else
        {
            TerminalSvc.AddLog($"Accessing {file.FileName}...", LogType.System);
        }

        // Auto-close menu on mobile after selecting a file
      //  isCollapsed = true;

        await OnFileSelected.InvokeAsync(file); // This triggers the parent's method
    }

    
    
   
}
