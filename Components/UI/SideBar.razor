@inject ThemeService ThemeSvc
@inject TerminalService TerminalSvc
@inject ProjectStateService ProjectState
@inject ProjectManifestService Manifest

<div class="sidebar-explorer">
    @foreach (var group in Manifest.GetGroupedProjects())
    {
        <div class="category-folder">
            <span class="folder-label">@group.Key</span>

            @foreach (var file in group)
            {
                <div class="file-item @(IsSelected(file) ? "active" : "")"
                     @onclick="() => HandleFileClick(file)">
                    <span class="file-icon">@file.Icon</span>
                    <span class="file-name">@file.FileName@file.Extension</span>
                </div>
            }
        </div>
    }
</div>


@code {
    // private bool isCollapsed = true; // Sidebar starts closed on mobile

    // private void ToggleSidebar()
    // {
    //     isCollapsed = !isCollapsed;
    // }
    
    private ProjectFile? SelectedFile;

    [Parameter] public EventCallback<ProjectFile> OnFileSelected { get; set; }

    private bool IsSelected(ProjectFile file) =>
        ProjectState.SelectedFile?.FileName == file.FileName;
   

    protected override void OnInitialized()
    {
        // Optionally, select the first file by default
       // ProjectState.SelectFile(ProjectManifest.First(p => p.FileName == "Uplink"));
    }

    //  var filteredProjects = ProjectManifest.Where(p => p.FileName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

    private async Task HandleFileClick(ProjectFile file)
    {
        ProjectState.SelectFile(file);
        // 1. Update the global site glow
        ThemeSvc.UpdateTheme(file.AccentColor);
        TerminalSvc.AddLog($"MOUNTING_MODULE: {file.FileName.ToUpper()}", LogType.System);

        // 2. Log the action to your new Terminal Service
        TerminalSvc.AddLog($"Loading module: {file.FileName}{file.Extension}...", LogType.System);
        TerminalSvc.AddLog($"Setting environment accent to {file.AccentColor}.", LogType.Success);

        // 3. (Optional) Navigate or Update Main Stage
        ProjectState.SelectFile(file); // This is where the variable is "Set"

        if (file.Extension == ".link")
        {
            TerminalSvc.AddLog("WARNING: Establishing unencrypted bridge to external nodes...", LogType.Warning);
            TerminalSvc.AddLog("UPLINK_PROTOCOL: Active.", LogType.Success);
        }
        else
        {
            TerminalSvc.AddLog($"Accessing {file.FileName}...", LogType.System);
        }

        // Auto-close menu on mobile after selecting a file
      //  isCollapsed = true;

        await OnFileSelected.InvokeAsync(file); // This triggers the parent's method
    }

    
    
   
}
