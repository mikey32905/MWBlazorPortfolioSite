@inject ThemeService ThemeSvc
@inject TerminalService TerminalSvc
@inject ProjectStateService ProjectState
@inject ProjectManifestService Manifest
@inject NavigationManager Nav
@inject HttpClient Http
@implements IDisposable


<div style="background-color: red; width: 260px; height: 100vh;">
    <div class="sidebar-explorer">
        <div class="sidebar-header">
            <h3>PROJECTS_EXE</h3>
        </div>

        @* DEBUG PIXELS: If this is Red, the list is null. If Green, the list is ready. *@
        <div style="height: 2px; width: 100%; background: @(ProjectState.ProjectFiles == null ? "red" : "green")"></div>

        <div class="file-tree">
            @if (ProjectState.ProjectFiles == null)
            {
                @*  <p>Loading Files...</p> *@
                <div class="sidebar-loading">INITIALIZING_FILESYSTEM...</div>
            }
            else
            {
                @foreach (var categoryGroup in ProjectState.ProjectFiles.GroupBy(f => f.Category))
                {
                    var category = categoryGroup.Key;
                    bool isOpen = expandedCategories.Contains(category);

                    <div class="folder-section">
                        @* Toggle folder state on click *@
                        <div class="folder-header" @onclick="() => ToggleFolder(category)" style="cursor: pointer;">
                            <span class="folder-arrow">@(isOpen ? "▼" : "▶")</span>
                            <span class="folder-icon">@(isOpen ? "📂" : "📁")</span>
                            <span class="folder-name">@category</span>
                        </div>

                        @if (isOpen)
                        {
                            <div class="folder-content">
                                @foreach (var file in categoryGroup)
                                {
                                    <div class="file-item @(ProjectState.SelectedFile == file ? "active" : "")"
                                         style="--accent-color: @file.AccentColor"
                                         @onclick="() => HandleFileClick(file)">
                                        <span class="icon">@file.Icon</span>
                                        <span class="text">@file.FileName</span>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            }
        </div>

    </div>

</div>


@code {
    // Stores the names of the folders that are currently expanded
    private HashSet<string> expandedCategories = new();
    
    private ProjectFile? SelectedFile;

    [Parameter] public EventCallback<ProjectFile> OnFileSelected { get; set; }

    private bool IsSelected(ProjectFile file) =>
        ProjectState.SelectedFile?.FileName == file.FileName;
   

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to the event
        ProjectState.OnChange += StateHasChanged;

        // Fetch data
        await ProjectState.InitializeAsync(Http);
  
    }

    protected override void OnInitialized()
    {
        // Optional: Start with all folders expanded
        if (ProjectState.ProjectFiles != null)
        {
            foreach (var cat in ProjectState.ProjectFiles.Select(f => f.Category).Distinct())
            {
                expandedCategories.Add(cat);
            }
        }

        ProjectState.OnChange += StateHasChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        // If the data hasn't arrived yet, exit gracefully
        if (ProjectState.ProjectFiles == null || !ProjectState.ProjectFiles.Any())
        {
            return;
        }

        foreach (var cat in ProjectState.ProjectFiles.Select(f => f.Category).Distinct())
        {
            if (!expandedCategories.Contains(cat))
            {
                expandedCategories.Add(cat);
            }
        }
    }

    private void ToggleFolder(string category)
    {
        if (expandedCategories.Contains(category))
        {
            expandedCategories.Remove(category);
        }
        else
        {
            expandedCategories.Add(category);
        }
    }

    private async Task HandleFileClick(ProjectFile file)
    {
        var previousFile = ProjectState.SelectedFile;
        
        // 1. Update the global state so the editor knows what's selected
        ProjectState.SelectFile(file);

        // Get the destination route
        string destination = file.Category switch
        {
            "LIVE_APPS" => "live-app",
            "SYSTEM_CORE" when file.FileName == "Identity" => "identity", // The Unique Dossier
            "SYSTEM_CORE" when file.FileName == "System_Diagnostic" => "system-diagnostic",
            "SYSTEM_CORE" when file.FileName == "Uplink" => "uplink",
            _ => file.Extension == ".xaml" ? "wpf-viewer" : "source-viewer" // The IDE Viewer
        };

         // 3. Smart Navigation
        if (Nav.Uri.EndsWith(destination, StringComparison.OrdinalIgnoreCase) || 
           (destination == "/" && Nav.Uri == Nav.BaseUri))
        {
            // We are already on the page! 
            // Just let the Service event handle the UI update.
        }
        else
        {
            // We are on a different page, so move there.
            Nav.NavigateTo(destination);
        }
       

        // 1. Update the global site glow
        ThemeSvc.UpdateTheme(file.AccentColor);
        TerminalSvc.AddLog($"MOUNTING_MODULE: {file.FileName.ToUpper()}", LogType.System);

        // 2. Log the action to your new Terminal Service
        TerminalSvc.AddLog($"Loading module: {file.FileName}{file.Extension}...", LogType.System);
        TerminalSvc.AddLog($"Setting environment accent to {file.AccentColor}.", LogType.Success);

        await OnFileSelected.InvokeAsync(file); // This triggers the parent's method
    }

    
    // Unsubscribe when the sidebar is destroyed to prevent memory leaks
    public void Dispose()
    {
        ProjectState.OnChange -= StateHasChanged;
    }
   
}
