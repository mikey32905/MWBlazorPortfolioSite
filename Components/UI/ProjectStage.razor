@inject ProjectStateService ProjectState


<div class="stage-container">
    @if (ProjectState.SelectedFile == null)
    {
        <EmptyState />
    }
    else
    {
        <div class="stage-header">
            <span class="breadcrumb">SYSTEM / @ProjectState.SelectedFile.Category.ToUpper() / @ProjectState.SelectedFile.FileName@ProjectState.SelectedFile.Extension</span>
        </div>

        <div class="stage-viewport">
            @* @switch (ProjectState.SelectedFile.Extension.ToLower())
            {
                case ".xaml":
                    <WPFWindow Project="ProjectState.SelectedFile" />
                    break;
                
                case ".razor":
                case ".cs":
                    <CodeEditorView Project="ProjectState.SelectedFile" />
                    break;

                case ".link":
                    <UplinkView />
                    break;

                case "Identity":
                    <IdentityView Project="ProjectState.SelectedFile" />
                break;

                default:
                    @if (ProjectState.SelectedFile?.Extension == ".xaml")
                    {
                        <WPFWindow Project="ProjectState.SelectedFile" />
                    }
                    else if (ProjectState.SelectedFile != null)
                    {
                        <CodeEditorView Project="ProjectState.SelectedFile" />
                    }
                 break;
            } *@
            @if (ProjectState.SelectedFile?.FileName == "Identity")
            {
                @* This is the specialized view that contains BOTH the code and the HUD *@
                <IdentityView />
            }
            else
            {
                @* Standard logic for all other files *@
                @switch (ProjectState.SelectedFile?.Extension?.ToLower())
                {
                    case ".razor" when !string.IsNullOrEmpty(ProjectState.SelectedFile.LiveUrl):
                        <LiveAppViewer ProjectUrl="@ProjectState.SelectedFile.LiveUrl" />
                        break;
                    case ".diag":
                        <SystemDiagnostic />
                        break;
                    case ".xaml":
                        <WPFWindow Project="ProjectState.SelectedFile" />
                        break;
                    case ".link":
                        <UplinkView />
                        break;
                    default:
                        <CodeEditorView @key="ProjectState.SelectedFile?.PhysicalPath"
                                        SelectedFile="ProjectState.SelectedFile" />
                        break;
                }
            }
        </div>

        <style>
            .wpf-active {
                /* This creates a soft halo behind the WPF window */
                background: radial-gradient(circle, rgba(var(--accent-rgb), 0.1) 0%, transparent 70%);
            }
        </style>
    }
</div>

@code {
    protected override void OnInitialized()
    {
        ProjectState.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        ProjectState.OnChange -= StateHasChanged;
    }
}
